{% extends 'admin/base.html' %}

{% block title %}Edit Project | RoZoom Admin{% endblock %}

{% block content %}
<div class="admin-main">
    <div class="admin-card">
        <div class="admin-card-header">
            <h2><i class="fas fa-edit"></i> Edit Project: {{ project.name }}</h2>
            <a href="{{ url_for('admin.projects') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Projects
            </a>
        </div>
        
        <form method="POST">
            {{ form.csrf_token }}
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="name" class="form-label">Project Name *</label>
                        {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.name.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else "")) }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.description.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        {{ form.status(class="form-control" + (" is-invalid" if form.status.errors else "")) }}
                        {% if form.status.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.status.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="user_id" class="form-label">User</label>
                        {{ form.user_id(class="form-control" + (" is-invalid" if form.user_id.errors else "")) }}
                        {% if form.user_id.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.user_id.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Deadline</label>
                        {{ form.deadline(class="form-control" + (" is-invalid" if form.deadline.errors else "")) }}
                        {% if form.deadline.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.deadline.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Project Info</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>ID:</strong> {{ project.id }}</p>
                            <p><strong>Created:</strong> {{ project.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            <p><strong>Updated:</strong> {{ project.updated_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            {% if project.completed_date %}
                            <p><strong>Completed:</strong> {{ project.completed_date.strftime('%d.%m.%Y') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Project
                </button>
                <a href="{{ url_for('admin.projects') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
    
    <!-- Project Stages -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h2><i class="fas fa-tasks"></i> Project Stages</h2>
            <button class="btn btn-success" onclick="addStage()">
                <i class="fas fa-plus"></i> Add Stage
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Stage Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stagesTable">
                    {% for stage in stages %}
                    <tr data-stage-id="{{ stage.id }}">
                        <td>{{ stage.order_number }}</td>
                        <td>
                            <input type="text" class="form-control form-control-sm stage-input"
                                   data-field="name"
                                   value="{{ stage.name }}">
                        </td>
                        <td>
                            <textarea class="form-control form-control-sm stage-input" rows="2"
                                      data-field="description">{{ stage.description or '' }}</textarea>
                        </td>
                        <td>
                            <select class="form-control form-control-sm stage-input"
                                    data-field="status">
                                <option value="pending" {% if stage.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="in_progress" {% if stage.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                <option value="completed" {% if stage.status == 'completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm stage-input"
                                   data-field="start_date"
                                   value="{% if stage.start_date %}{{ stage.start_date.strftime('%Y-%m-%d') }}{% endif %}">
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm stage-input"
                                   data-field="end_date"
                                   value="{% if stage.end_date %}{{ stage.end_date.strftime('%Y-%m-%d') }}{% endif %}">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-stage-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function updateStage(stageId, field, value) {
    const formData = new FormData();
    formData.append(field, value);
    
    fetch(`/admin/projects/{{ project.id }}/stages/${stageId}/update`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRF-Token': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showMessage('Stage updated successfully!', 'success');
        } else {
            showMessage('Error updating stage: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error updating stage', 'error');
    });
}

function addStage() {
    const stageName = prompt('Enter stage name:');
    if (!stageName) return;
    
    const formData = new FormData();
    formData.append('name', stageName);
    formData.append('order_number', document.querySelectorAll('#stagesTable tr').length + 1);
    
    fetch('/admin/projects/{{ project.id }}/stages', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRF-Token': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Reload to show new stage
        } else {
            showMessage('Error adding stage: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error adding stage', 'error');
    });
}

function deleteStage(stageId) {
    if (!confirm('Are you sure you want to delete this stage?')) return;
    
    // For now, just show a message - deletion would need backend implementation
    showMessage('Stage deletion not implemented yet', 'warning');
}

function showMessage(message, type) {
    // Simple message display - you can enhance this
    alert(message);
}

// Add event listeners for dynamic elements
document.addEventListener('DOMContentLoaded', function() {
    // Handle stage field updates
    document.addEventListener('change', function(e) {
        const target = e.target;
        if (target.hasAttribute('data-stage-id') && target.hasAttribute('data-field')) {
            const stageId = target.getAttribute('data-stage-id');
            const field = target.getAttribute('data-field');
            const value = target.value;
            updateStage(stageId, field, value);
        }
    });
    
    // Handle add stage button
    document.addEventListener('click', function(e) {
        if (e.target.hasAttribute('data-action') && e.target.getAttribute('data-action') === 'add-stage') {
            addStage();
        }
    });
    
    // Handle delete stage buttons
    document.addEventListener('click', function(e) {
        if (e.target.hasAttribute('data-action') && e.target.getAttribute('data-action') === 'delete-stage') {
            const stageId = e.target.getAttribute('data-stage-id');
            deleteStage(stageId);
        }
    });
});
</script>
{% endblock %}
