import os
import openai
from flask import Blueprint, request, jsonify
from dotenv import load_dotenv
from app.models.client import db, ClientRequest  # –î–æ–¥–∞—î–º–æ –±–∞–∑—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¢–ó

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
load_dotenv()

# –û—Ç—Ä–∏–º—É—î–º–æ API-–∫–ª—é—á OpenAI
openai.api_key = os.getenv("OPENAI_API_KEY")

# –°—Ç–≤–æ—Ä—é—î–º–æ Blueprint –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞
chatbot_bp = Blueprint("chatbot", __name__)

# üîπ –ì–æ–ª–æ–≤–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç (–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –ø—Ä–æ–¥–∞–≤–µ—Ü—å)
MAIN_PROMPT = """
–¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, —è–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç—É—î –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ç–∞ –∑–∞–ª—É—á–∞—î —ó—Ö –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å–æ–º.
–¢–≤–æ—è –º–µ—Ç–∞ ‚Äî —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–∫–∞–≤—É —Ç–∞ —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É —Ä–æ–∑–º–æ–≤—É, —â–æ–± –ø–æ—è—Å–Ω–∏—Ç–∏ –≤—Å—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Å–∞–π—Ç—É —Ç–∞ –∑–∞–æ—Ö–æ—Ç–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑—Ä–æ–±–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫.

üîπ –û—Å–Ω–æ–≤–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:
- –í—ñ—Ç–∞—î—à –∫–ª—ñ—î–Ω—Ç–∞, –¥–æ–ø–æ–º–∞–≥–∞—î—à –π–æ–º—É —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏—Å—è –∑ —Å–µ—Ä–≤—ñ—Å–æ–º.
- –í–∏–≥—ñ–¥–Ω–æ –ø–æ–¥–∞—î—à —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, –ø—ñ–¥–∫—Ä–µ—Å–ª—é—é—á–∏ –∞–Ω–æ–Ω—ñ–º–Ω—ñ—Å—Ç—å, –∑—Ä—É—á–Ω—ñ—Å—Ç—å —Ç–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É.
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à –µ–ª–µ–º–µ–Ω—Ç–∏ –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—ó –ø—Ä–æ–¥–∞–∂—ñ–≤: –ø—Ä–∞—Ü—é—î—à —ñ–∑ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è–º–∏, –Ω–∞–≤–æ–¥–∏—à –ø—Ä–∏–∫–ª–∞–¥–∏ —É—Å–ø—ñ—à–Ω–∏—Ö –∫–µ–π—Å—ñ–≤.
- –°–ø–æ–Ω—É–∫–∞—î—à –∫–ª—ñ—î–Ω—Ç–∞ –¥–æ –¥—ñ—ó (–ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π —Ä–æ–∑–¥—ñ–ª, –ø–æ—á–∞—Ç–∏ –∑–∞–ø–æ–≤–Ω—é–≤–∞—Ç–∏ –¢–ó).
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à –∂–∏–≤–∏–π —Å—Ç–∏–ª—å —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è, –Ω—ñ–±–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –º–µ–Ω–µ–¥–∂–µ—Ä-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç.

üéØ **–ì–æ–ª–æ–≤–Ω–∞ –º–µ—Ç–∞** ‚Äî –∑—Ä–æ–±–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞ –∑–∞—Ü—ñ–∫–∞–≤–ª–µ–Ω–∏–º —ñ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏ –π–æ–≥–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Å–µ—Ä–≤—ñ—Å!
"""

# üîπ –ü—Ä–æ–º–ø—Ç–∏ –¥–ª—è —Ç–µ–º–∞—Ç–∏—á–Ω–∏—Ö –∞—Å–∏—Å—Ç–µ–Ω—Ç—ñ–≤ (–µ–∫—Å–ø–µ—Ä—Ç—ñ–≤)
EXPERT_PROMPTS = {
    "web-dev": """
        –¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —ñ–∑ –≤–µ–±-—Ä–æ–∑—Ä–æ–±–∫–∏.
        –¢–≤–æ—è –º–µ—Ç–∞ ‚Äî –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —á—ñ—Ç–∫–µ —Ç–µ—Ö–Ω—ñ—á–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è, –∑–∞–ø–∏—Ç—É—é—á–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ.
        üîπ –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:
        - –î—ñ–∑–Ω–∞—î—à—Å—è –ø–æ—Ç—Ä–µ–±–∏ –∫–ª—ñ—î–Ω—Ç–∞ (—è–∫–∏–π —Å–∞–π—Ç, —è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó).
        - –î–∞—î—à –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ –ø–æ—Ä–∞–¥–∏ —â–æ–¥–æ –≤–∏–±–æ—Ä—É —Å—Ç–µ–∫—É —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π.
        - –Ø–∫—â–æ –¢–ó –Ω–µ—á—ñ—Ç–∫–µ, —É—Ç–æ—á–Ω—é—î—à –≤–∞–∂–ª–∏–≤—ñ –¥–µ—Ç–∞–ª—ñ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –Ω–µ—Ä–æ–∑—É–º—ñ–Ω–Ω—è.
        - –ü—ñ–¥—Å—É–º–æ–≤—É—î—à —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —Ç–∞ –≥–æ—Ç—É—î—à –¥–æ –ø–µ—Ä–µ–¥–∞—á—ñ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—É.
    """,
    "chatbots": """
        –¢–∏ ‚Äî –µ–∫—Å–ø–µ—Ä—Ç —ñ–∑ —Ä–æ–∑—Ä–æ–±–∫–∏ —á–∞—Ç-–±–æ—Ç—ñ–≤.
        –¢–≤–æ—è –º–µ—Ç–∞ ‚Äî –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —ñ–¥–µ–∞–ª—å–Ω–µ –¢–ó –¥–ª—è –π–æ–≥–æ –±–æ—Ç–∞.
        üîπ –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:
        - –£—Ç–æ—á–Ω—é—î—à, –¥–ª—è —è–∫–æ–≥–æ –º–µ—Å–µ–Ω–¥–∂–µ—Ä–∞ –ø–æ—Ç—Ä—ñ–±–µ–Ω –±–æ—Ç (Telegram, WhatsApp, Discord).
        - –ó–∞–ø–∏—Ç—É—î—à, —è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –≤ –±–æ—Ç—ñ (–∞–≤—Ç–æ-–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ, —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ CRM, –æ–ø–ª–∞—Ç–∞).
        - –ü—Ä–æ–ø–æ–Ω—É—î—à –æ–ø—Ç–∏–º–∞–ª—å–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
        - –ü—ñ–¥—Å—É–º–æ–≤—É—î—à –æ—Ç—Ä–∏–º–∞–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø–µ—Ä–µ–¥ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–º –∑–∞–ø–∏—Å–æ–º —É –±–∞–∑—É.
    """,
    "automation": """
        –¢–∏ ‚Äî —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç –∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –±—ñ–∑–Ω–µ—Å—É.
        üîπ –Ø–∫ —Ç–∏ –¥–æ–ø–æ–º–∞–≥–∞—î—à –∫–ª—ñ—î–Ω—Ç—É:
        - –ó–∞–ø–∏—Ç—É—î—à, —è–∫—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏.
        - –ü—Ä–æ–ø–æ–Ω—É—î—à —Ä—ñ—à–µ–Ω–Ω—è (–±–æ—Ç–∏, CRM, –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–∏—Ö, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è email).
        - –î–∞—î—à —Ä–µ–∞–ª—å–Ω—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –¥–ª—è —Å—Ö–æ–∂–∏—Ö –∫–æ–º–ø–∞–Ω—ñ–π.
        - –î–æ–ø–æ–º–∞–≥–∞—î—à –∫–ª—ñ—î–Ω—Ç—É —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –¢–ó, —â–æ–± –≤–æ–Ω–æ –±—É–ª–æ –∑—Ä—É—á–Ω–µ –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤.
    """,
    "ai-ml": """
        –¢–∏ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è AI —Ç–∞ ML.
        üîπ –Ø–∫ —Ç–∏ –¥–æ–ø–æ–º–∞–≥–∞—î—à:
        - –ó–∞–ø–∏—Ç—É—î—à —É –∫–ª—ñ—î–Ω—Ç–∞, –¥–ª—è —á–æ–≥–æ –π–æ–º—É AI (–∞–Ω–∞–ª—ñ–∑ –¥–∞–Ω–∏—Ö, NLP, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏).
        - –ü—Ä–æ–ø–æ–Ω—É—î—à –ø—ñ–¥—Ö–æ–¥–∏ (GPT, –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂—ñ, –∞–Ω–∞–ª—ñ–∑ —Ç–µ–∫—Å—Ç—ñ–≤, —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å).
        - –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, –ø–æ—è—Å–Ω—é—î—à —Å–∫–ª–∞–¥–Ω—ñ —Ä–µ—á—ñ –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.
        - –î–æ–ø–æ–º–∞–≥–∞—î—à –∫–ª—ñ—î–Ω—Ç—É —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¢–ó –¥–ª—è AI-—Ä—ñ—à–µ–Ω–Ω—è.
    """,
    "media-buying": """
        –¢–∏ ‚Äî –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç –∑ –º–µ–¥—ñ–∞–±–∞—ó–Ω–≥—É.
        üîπ –¢–≤–æ—ó –∑–∞–¥–∞—á—ñ:
        - –î–æ–ø–æ–º–∞–≥–∞—î—à –∫–ª—ñ—î–Ω—Ç—É –æ–±—Ä–∞—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ñ —Ä–µ–∫–ª–∞–º–Ω—ñ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏.
        - –£—Ç–æ—á–Ω—é—î—à —Ü—ñ–ª—å–æ–≤—É –∞—É–¥–∏—Ç–æ—Ä—ñ—é, –±—é–¥–∂–µ—Ç, KPI.
        - –î–∞—î—à –ø–æ—Ä–∞–¥–∏, —è–∫ –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Å—ñ—é —Ä–µ–∫–ª–∞–º–∏.
        - –ó–∞–ø–∏—Ç—É—î—à —É –∫–ª—ñ—î–Ω—Ç–∞ –≤—Å—ñ –¥–µ—Ç–∞–ª—ñ —Ç–∞ —Å—Ç–≤–æ—Ä—é—î—à –¢–ó.
    """,
    "databases": """
        –¢–∏ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —ñ–∑ –±–∞–∑ –¥–∞–Ω–∏—Ö.
        üîπ –Ø–∫ —Ç–∏ –¥–æ–ø–æ–º–∞–≥–∞—î—à:
        - –ó–∞–ø–∏—Ç—É—î—à, —è–∫—ñ –¥–∞–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç–∞ –æ–±—Ä–æ–±–ª—è—Ç–∏.
        - –ü—Ä–æ–ø–æ–Ω—É—î—à —Ç–∏–ø –ë–î (SQL, NoSQL) –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∑–∞–¥–∞—á—ñ.
        - –Ø–∫—â–æ –∫–ª—ñ—î–Ω—Ç –Ω–µ –∑–Ω–∞—î, –¥–æ–ø–æ–º–∞–≥–∞—î—à –π–æ–º—É –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é.
        - –§–æ—Ä–º—É—î—à —á—ñ—Ç–∫–µ –¢–ó –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞.
    """
}

def generate_response(prompt, user_message):
    """
    –ì–µ–Ω–µ—Ä—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å OpenAI –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º –ø—Ä–æ–º–ø—Ç–æ–º.
    """
    if not user_message:
        return jsonify({"error": "–ü–æ—Ä–æ–∂–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"}), 400

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4o-mini",
            messages=[{"role": "system", "content": prompt}, {"role": "user", "content": user_message}]
        )
        bot_reply = response.choices[0].message.content
        return jsonify({"response": bot_reply})
    except Exception as e:
        import traceback
        traceback.print_exc()
        return jsonify({"error": str(e)}), 500

# üîπ –ì–æ–ª–æ–≤–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç (–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥)
@chatbot_bp.route("/", methods=["POST"], strict_slashes=False)
def main_chatbot():
    """
    –ì–æ–ª–æ–≤–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∑–∞–ª—É—á–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤.
    """
    data = request.json
    user_message = data.get("message", "")
    return generate_response(MAIN_PROMPT, user_message)

# üîπ –¢–µ–º–∞—Ç–∏—á–Ω—ñ –∞—Å–∏—Å—Ç–µ–Ω—Ç–∏ (–µ–∫—Å–ø–µ—Ä—Ç–∏)
@chatbot_bp.route("/<string:category>", methods=["POST"])
def category_chatbot(category):
    """
    –ê—Å–∏—Å—Ç–µ–Ω—Ç–∏ —É –Ω–∞–ø—Ä—è–º–∞—Ö —Ä–æ–±–æ—Ç–∏: web-dev, chatbots, automation —Ç–æ—â–æ.
    """
    data = request.json
    user_message = data.get("message", "")

    if category in EXPERT_PROMPTS:
        return generate_response(EXPERT_PROMPTS[category], user_message)
    else:
        return jsonify({"error": "–ù–µ–≤—ñ–¥–æ–º–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è"}), 400
